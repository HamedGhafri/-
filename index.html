<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¯ÙŠÙˆØ§Ù† Ø­Ù…Ø¯ Ø§Ù„ØºØ§ÙØ±ÙŠ</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="fade">

<div class="top-bar">ğŸ“œ Ø¯ÙŠÙˆØ§Ù† Ø­Ù…Ø¯ Ø§Ù„ØºØ§ÙØ±ÙŠ</div>

<button id="modeToggle" onclick="toggleMode()">ğŸŒ“</button>

<div class="container">

    <h1>Ø¯ÙŠÙˆØ§Ù† Ø­Ù…Ø¯ Ø§Ù„ØºØ§ÙØ±ÙŠ</h1>

    <div class="actions">
        <a class="btn" href="#" onclick="randomPoem()">Ù‚ØµÙŠØ¯Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</a>
        <a class="btn" href="about.html">Ø¹Ù† Ø§Ù„Ø´Ø§Ø¹Ø±</a>
    </div>

    <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚ØµÙŠØ¯Ø© Ø£Ùˆ ÙƒÙ„Ù…Ø©..." oninput="filterPoems()">

    <div id="categoriesBox" class="categories"></div>

    <div id="todayBox" class="today-box fade">
        <div class="today-title">Ø¨ÙŠØª Ø§Ù„ÙŠÙˆÙ…</div>
        <div id="todayContent"></div>
    </div>

    <div id="results"></div>

    <div id="list" class="fade"></div>

</div>

<script>
let poemList = [];
let allLines = [];
let allPoems = [];
let categories = new Set();

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
function toggleMode() {
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark"));
}
if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark");
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ */
async function loadPoems() {
    const res = await fetch("poems.txt");
    const text = await res.text();

    const poems = text.split("===\n").map(p => p.trim()).filter(p => p);

    poemList = poems.map((poem, index) => {
        const lines = poem.split("\n").map(l => l.trim()).filter(l => l);

        const title = lines[0];
        const category = lines[1].startsWith("@") ? lines[1].replace("@", "") : "ØºÙŠØ± Ù…ØµÙ†Ù‘Ù";
        const body = lines.slice(2).join("\n");

        categories.add(category);
        allPoems.push(poem);

        const poemBodyLines = lines.slice(2);
        allLines.push(...poemBodyLines);

        return {
            id: index,
            title,
            category,
            body
        };
    });

    createCategoryButtons();
    display(poemList);
    showBaytOfDay();
}

/* Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ */
function createCategoryButtons() {
    const box = document.getElementById("categoriesBox");
    box.innerHTML = "";

    box.innerHTML += `<button class="cat-btn" onclick="filterByCategory('Ø§Ù„ÙƒÙ„')">Ø§Ù„ÙƒÙ„</button>`;

    Array.from(categories)
        .sort()
        .forEach(cat => {
            box.innerHTML += `
                <button class="cat-btn" onclick="filterByCategory('${cat}')">${cat}</button>
            `;
        });
}

/* ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ */
function filterByCategory(cat) {
    if (cat === "Ø§Ù„ÙƒÙ„") {
        display(poemList);
        return;
    }

    const filtered = poemList.filter(p => p.category === cat);
    display(filtered);
}

/* Ø¹Ø±Ø¶ Ø§Ù„ÙÙ‡Ø±Ø³ */
function display(arr) {
    const list = document.getElementById("list");
    const results = document.getElementById("results");

    results.innerHTML = "";
    list.innerHTML = "";

    arr.forEach(poem => {
        list.innerHTML += `
            <a class="poem-card fade" href="viewer.html?id=${poem.id}">
                <div class="title">${poem.title}</div>
                <div class="category">${poem.category}</div>
            </a>
        `;
    });
}

/* Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… */
function filterPoems() {
    const text = document.getElementById("search").value.trim();
    const resultsDiv = document.getElementById("results");

    if (text === "") {
        resultsDiv.innerHTML = "";
        display(poemList);
        return;
    }

    let resultsHTML = "";
    const query = text;

    poemList.forEach((p, i) => {
        const poemText = allPoems[i];

        if (poemText.includes(query) || p.title.includes(query)) {

            let snippet = "";
            const lines = poemText.split("\n");

            for (let line of lines) {
                if (line.includes(query)) {
                    snippet = line.replace(
                        new RegExp(query, "g"),
                        `<mark>${query}</mark>`
                    );
                    break;
                }
            }

            resultsHTML += `
                <a class="poem-search-card" href="viewer.html?id=${p.id}">
                    <div class="search-title">${p.title}</div>
                    <div class="search-snippet">${snippet || "â€¦"}</div>
                </a>
            `;
        }
    });

    resultsDiv.innerHTML = resultsHTML || "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</p>";
}

/* Ù‚ØµÙŠØ¯Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© */
function randomPoem() {
    const id = Math.floor(Math.random() * poemList.length);
    window.location.href = `viewer.html?id=${id}`;
}

/* Ø¨ÙŠØª Ø§Ù„ÙŠÙˆÙ… */
function showBaytOfDay() {
    const today = new Date().getDate();
    const index = today % allLines.length;
    const line1 = allLines[index];
    const line2 = allLines[index + 1] || "";
    document.getElementById("todayContent").innerHTML = `${line1}<br>${line2}`;
}

loadPoems();
</script>

</body>
</html>
