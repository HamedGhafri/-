<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¯ÙŠÙˆØ§Ù† Ø­Ù…Ø¯ Ø§Ù„ØºØ§ÙØ±ÙŠ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="fade">

  <div class="top-bar">ğŸ“œ Ø¯ÙŠÙˆØ§Ù† Ø­Ù…Ø¯ Ø§Ù„ØºØ§ÙØ±ÙŠ</div>

  <button id="modeToggle" onclick="toggleMode()">ğŸŒ“</button>

  <div class="container">

    <h1>Ø¯ÙŠÙˆØ§Ù† Ø­Ù…Ø¯ Ø§Ù„ØºØ§ÙØ±ÙŠ</h1>

    <div class="actions">
      <a class="btn" href="#" onclick="randomPoem()">Ù‚ØµÙŠØ¯Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</a>
      <a class="btn" href="favorites.html">Ø§Ù„Ù…ÙØ¶Ù‘Ù„Ø§Øª â­</a>
      <a class="btn" href="about.html">Ø¹Ù† Ø§Ù„Ø´Ø§Ø¹Ø±</a>
    </div>

    <input id="search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚ØµÙŠØ¯Ø© Ø£Ùˆ ÙƒÙ„Ù…Ø©..." oninput="filterPoems()" />

    <div id="categoriesBox" class="categories"></div>

    <div id="todayBox" class="today-box fade">
      <div class="today-title">Ø¨ÙŠØª Ø§Ù„ÙŠÙˆÙ…</div>
      <div id="todayContent"></div>
    </div>

    <div id="results"></div>

    <div id="list" class="fade"></div>

  </div>

<script>
/* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ===== */
let poemList = [];
let allLines = [];
let allPoems = [];
let categories = new Set();

/* ===== Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ===== */
function toggleMode() {
  document.body.classList.toggle('dark');
  localStorage.setItem('darkMode', document.body.classList.contains('dark'));
}
if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ =====
   ØµÙŠØºØ© ÙƒÙ„ Ù‚ØµÙŠØ¯Ø© ÙÙŠ poems.txt ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ†:
   Ø³Ø·Ø± 1: Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
   Ø³Ø·Ø± 2: @Ø§Ù„ØªØµÙ†ÙŠÙ
   Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø³Ø·ÙˆØ±: Ø§Ù„Ø£Ø¨ÙŠØ§Øª
   Ø«Ù… === Ù„Ù„ÙØ§ØµÙ„
*/
async function loadPoems() {
  const res = await fetch('poems.txt');
  const text = await res.text();

  const poems = text.split('===\n').map(p => p.trim()).filter(p => p);
  poemList = [];
  allLines = [];
  allPoems = [];
  categories = new Set();

  poems.forEach((poem, index) => {
    const lines = poem.split('\n').map(l => l.trim()).filter(l => l);
    const title = lines[0] || `Ù‚ØµÙŠØ¯Ø© ${index+1}`;
    const category = (lines[1] && lines[1].startsWith('@')) ? lines[1].replace('@','') : 'ØºÙŠØ± Ù…ØµÙ†Ù‘Ù';
    const body = lines.slice(2).join('\n');

    poemList.push({ id: index, title, category, body });
    allPoems.push(poem); // Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¨Ø£Ø³Ø·Ø±Ù‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©) Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
    const poemBodyLines = lines.slice(2);
    allLines.push(...poemBodyLines);
    categories.add(category);
  });

  createCategoryButtons();
  display(poemList);
  showBaytOfDay();
  runScrollObserver();
}

/* ===== Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ===== */
function createCategoryButtons() {
  const box = document.getElementById('categoriesBox');
  box.innerHTML = '';
  box.innerHTML += `<button class="cat-btn" onclick="filterByCategory('Ø§Ù„ÙƒÙ„')">Ø§Ù„ÙƒÙ„</button>`;
  Array.from(categories).sort().forEach(cat => {
    box.innerHTML += `<button class="cat-btn" onclick="filterByCategory('${cat}')">${cat}</button>`;
  });
}

/* ===== ÙÙ„ØªØ±Ø© Ø§Ù„ØªØµÙ†ÙŠÙ ===== */
function filterByCategory(cat) {
  if (cat === 'Ø§Ù„ÙƒÙ„') {
    display(poemList);
    return;
  }
  const filtered = poemList.filter(p => p.category === cat);
  display(filtered);
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„ÙÙ‡Ø±Ø³ ===== */
function display(arr) {
  const list = document.getElementById('list');
  const results = document.getElementById('results');
  results.innerHTML = '';
  list.innerHTML = '';
  if (!arr.length) {
    list.innerHTML = '<p style="opacity:.8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØ§Ø¦Ø¯.</p>';
    return;
  }
  arr.forEach(poem => {
    list.innerHTML += `
      <a class="poem-card scroll-animate" href="viewer.html?id=${poem.id}">
        <div class="title">${poem.title}</div>
        <div class="category">${poem.category}</div>
      </a>
    `;
  });
  runScrollObserver();
}

/* ===== Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù‘Ù… (Ø¹Ù†ÙˆØ§Ù† + Ø£Ø¨ÙŠØ§Øª) Ù…Ø¹ Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ===== */
function filterPoems() {
  const text = document.getElementById('search').value.trim();
  const resultsDiv = document.getElementById('results');
  if (text === '') {
    resultsDiv.innerHTML = '';
    display(poemList);
    return;
  }

  const query = text;
  let resultsHTML = '';

  poemList.forEach((p, i) => {
    const poemText = allPoems[i]; // Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù‚ØµÙŠØ¯Ø©
    if (poemText.includes(query) || p.title.includes(query)) {
      let snippet = '';
      const lines = poemText.split('\n');
      for (let line of lines) {
        if (line.includes(query)) {
          snippet = line.replace(new RegExp(escapeRegExp(query), 'gi'), match => `<mark>${match}</mark>`);
          break;
        }
      }
      resultsHTML += `
        <a class="poem-search-card scroll-animate" href="viewer.html?id=${p.id}">
          <div class="search-title">${p.title} <small style="opacity:.7">â€” ${p.category}</small></div>
          <div class="search-snippet">${snippet || '...'}</div>
        </a>
      `;
    }
  });

  resultsDiv.innerHTML = resultsHTML || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</p>';
  runScrollObserver();
}

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø³ÙƒØ§Øª Ø£Ø­Ø±Ù Ø§Ù„ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù†Ù…Ø·ÙŠØ© ÙÙŠ RegExp ===== */
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/* ===== Ù‚ØµÙŠØ¯Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ===== */
function randomPoem() {
  if (!poemList.length) return;
  const id = Math.floor(Math.random() * poemList.length);
  window.location.href = `viewer.html?id=${id}`;
}

/* ===== Ø¨ÙŠØª Ø§Ù„ÙŠÙˆÙ… ===== */
function showBaytOfDay() {
  if (!allLines.length) {
    document.getElementById('todayContent').innerHTML = '';
    return;
  }
  const today = new Date().getDate();
  const index = today % allLines.length;
  const line1 = allLines[index] || '';
  const line2 = allLines[index+1] || '';
  document.getElementById('todayContent').innerHTML = `${escapeHtml(line1)}<br>${escapeHtml(line2)}`;
}

/* ===== Ù‡Ø±ÙˆØ¨ HTML Ø¨Ø³ÙŠØ· ===== */
function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ===== ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ±: IntersectionObserver ===== */
let io = null;
function runScrollObserver() {
  const els = document.querySelectorAll('.scroll-animate');
  if ('IntersectionObserver' in window) {
    if (io) io.disconnect();
    io = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          e.target.classList.add('fade');
          io.unobserve(e.target);
        }
      });
    }, { threshold: 0.12 });
    els.forEach(el => io.observe(el));
  } else {
    // Ù…ØªØµÙØ­Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©: Ø£Ø¶Ù fade ÙÙˆØ±Ø§Ù‹
    els.forEach(el => el.classList.add('fade'));
  }
}

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ===== */
loadPoems();
</script>

</body>
</html>
