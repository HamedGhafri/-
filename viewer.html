<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµÙŠØ¯Ø©</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="fade">

  <div class="top-bar">ğŸ“– Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµÙŠØ¯Ø©</div>
  <button id="modeToggle" onclick="toggleMode()">ğŸŒ“</button>

  <div class="container">
    <a class="btn" href="index.html" style="margin-bottom:14px">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
    <a id="favBtn" class="btn" href="#" style="margin-bottom:14px; margin-left:8px" onclick="toggleFavorite(event)">â˜† Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø§Øª</a>

    <h1 id="title"></h1>

    <div id="poemBox" class="poem-box fade">
      <div id="content"></div>
    </div>
  </div>

<script>
/* ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ */
function toggleMode() {
  document.body.classList.toggle('dark');
  localStorage.setItem('darkMode', document.body.classList.contains('dark'));
}
if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');

/* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø§Øª (localStorage) */
function getFavorites() {
  try {
    const v = JSON.parse(localStorage.getItem('favoritePoems')||'[]');
    return Array.isArray(v)?v:[];
  } catch { return []; }
}
function saveFavorites(arr) {
  localStorage.setItem('favoritePoems', JSON.stringify(arr));
}
function isFavorited(id) {
  return getFavorites().includes(Number(id));
}
function setFavButton(id) {
  const btn = document.getElementById('favBtn');
  if (isFavorited(id)) btn.innerHTML = 'â˜… Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø§Øª';
  else btn.innerHTML = 'â˜† Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø§Øª';
}

/* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© */
function toggleFavorite(evt) {
  evt.preventDefault();
  const id = new URLSearchParams(window.location.search).get('id');
  if (id === null) return;
  const fav = getFavorites();
  const nid = Number(id);
  const idx = fav.indexOf(nid);
  if (idx === -1) fav.push(nid);
  else fav.splice(idx,1);
  saveFavorites(fav);
  setFavButton(nid);
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµÙŠØ¯Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø£Ø¨ÙŠØ§Øª */
async function loadPoem() {
  const res = await fetch('poems.txt');
  const text = await res.text();
  const poems = text.split('===\n').map(p => p.trim()).filter(p => p);
  const id = new URLSearchParams(window.location.search).get('id');
  if (!id || isNaN(id) || id < 0 || id >= poems.length) {
    document.getElementById('title').textContent = 'Ø§Ù„Ù‚ØµÙŠØ¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
    document.getElementById('content').innerHTML = '';
    return;
  }
  const poem = poems[id].split('\n').map(l=>l.trim()).filter(l=>l);
  const title = poem[0] || '';
  const categoryLine = poem[1] && poem[1].startsWith('@') ? poem[1].replace('@','') : '';
  const verses = poem.slice(2);

  document.getElementById('title').textContent = title;
  // Ø¨Ù†Ø§Ø¡ Ø£Ø¨ÙŠØ§Øª: ÙƒÙ„ Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ <p class="verse"> Ù…Ø¹ ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¨ÙŠØ§Øª Ø§Ù„ÙØ§Ø±ØºØ©
  const html = verses.map(line => {
    if (!line) return '<p class="verse empty"></p>';
    return `<p class="verse">${escapeHtml(line)}</p>`;
  }).join('');
  document.getElementById('content').innerHTML = html;
  setFavButton(Number(id));
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

loadPoem();
</script>

</body>
</html>
