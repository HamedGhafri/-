<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="عرض القصائد - ديوان حمد الغافري">
    <title>عرض القصائد | ديوان حمد الغافري</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="تبديل الوضع الليلي">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <i class="fas fa-book-open"></i>
                <span>ديوان حمد الغافري</span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html"><i class="fas fa-home"></i> الرئيسية</a></li>
                <li><a href="categories.html"><i class="fas fa-layer-group"></i> التصنيفات</a></li>
                <li><a href="search.html"><i class="fas fa-search"></i> البحث</a></li>
                <li><a href="about.html"><i class="fas fa-user"></i> عن الشاعر</a></li>
            </ul>
            <button class="nav-toggle" id="navToggle" aria-label="قائمة التنقل">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container main-content">
        
        <!-- Poems List View -->
        <div id="poemsListView" class="poems-view">
            <div class="section-header">
                <h1><i class="fas fa-book"></i> جميع القصائد</h1>
                <div class="view-controls">
                    <button class="control-btn" id="gridViewBtn" title="عرض شبكي">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="control-btn active" id="listViewBtn" title="عرض قائمة">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            <div class="poems-container" id="poemsContainer">
                <div class="loading-container">
                    <div class="loader"></div>
                    <p>جارٍ تحميل القصائد...</p>
                </div>
            </div>
        </div>

        <!-- Poem Detail View -->
        <div id="poemDetailView" class="poem-detail-view" style="display: none;">
            <div class="poem-header">
                <button class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-right"></i> العودة للقائمة
                </button>
                <div class="poem-actions">
                    <button class="action-btn" id="focusModeBtn" title="وضع القراءة المركزة">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <div class="poem-content-wrapper">
                <div class="decorative-ornament top-ornament">✦ ❁ ✦</div>
                <div class="decorative-border-top"></div>
                <h2 class="poem-main-title" id="poemTitle"></h2>
                <p class="poem-subtitle">— ديوان حمد الغافري —</p>
                <div class="poem-category-badge" id="poemCategory" style="display: none;"></div>
                <div class="decorative-border-bottom"></div>
                <div class="decorative-ornament bottom-ornament">✦ ❁ ✦</div>

                <div class="poem-verses-container" id="poemVerses"></div>

                <div class="poem-navigation">
                    <button class="nav-poem-btn" id="prevPoemBtn">
                        <i class="fas fa-chevron-right"></i> القصيدة السابقة
                    </button>
                    <button class="nav-poem-btn" id="nextPoemBtn">
                        القصيدة التالية <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3><i class="fas fa-book-open"></i> ديوان حمد الغافري</h3>
                    <p>منصة إلكترونية لعرض الأعمال الشعرية للشاعر حمد الغافري</p>
                </div>
                <div class="footer-section">
                    <h4>روابط سريعة</h4>
                    <ul class="footer-links">
                        <li><a href="index.html">الرئيسية</a></li>
                        <li><a href="categories.html">التصنيفات</a></li>
                <li><a href="about.html">عن الشاعر</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 ديوان حمد الغافري. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <style>
        .poems-view {
            min-height: 60vh;
        }

        .view-controls {
            display: flex;
            gap: var(--spacing-xs);
        }

        .control-btn {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .control-btn:hover,
        .control-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .poems-container {
            margin-top: var(--spacing-lg);
        }

        .poems-container.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
        }

        .poems-container.list-view .poem-item {
            margin-bottom: var(--spacing-md);
        }

        .poem-item {
            background: var(--surface-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            border-right: 4px solid var(--primary-color);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .poem-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .poem-item-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .poem-item-preview {
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: var(--spacing-sm);
            font-size: 1.1rem;
        }

        .poem-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-muted);
            font-family: var(--font-secondary);
        }

        .loading-container {
            text-align: center;
            padding: var(--spacing-xl);
        }

        /* Poem Detail View */
        .poem-detail-view {
            min-height: 70vh;
        }

        .poem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            opacity: 0.8;
        }

        .back-btn {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: var(--font-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            transition: all var(--transition-fast);
        }

        .back-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .poem-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .action-btn {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-3px);
        }

        .action-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .poem-content-wrapper {
            background: transparent;
            padding: var(--spacing-xl) 0;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .poem-main-title {
            font-size: 2.8rem;
            color: var(--primary-color);
            text-align: center;
            margin: var(--spacing-md) 0;
            font-family: var(--font-decorative);
            font-weight: 700;
            position: relative;
        }

        .poem-subtitle {
            text-align: center;
            color: var(--text-muted);
            font-size: 1.2rem;
            margin-bottom: var(--spacing-lg);
            font-family: var(--font-secondary);
        }

        .decorative-ornament {
            text-align: center;
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: var(--spacing-md) 0;
            letter-spacing: 0.5rem;
            opacity: 0.7;
            animation: ornamentGlow 3s ease-in-out infinite;
        }

        @keyframes ornamentGlow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .decorative-border-top,
        .decorative-border-bottom {
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--primary-color) 20%, 
                var(--gold-color) 50%, 
                var(--primary-color) 80%, 
                transparent 100%);
            margin: var(--spacing-md) auto;
            width: 80%;
            max-width: 500px;
            position: relative;
        }

        .decorative-border-top::before,
        .decorative-border-top::after,
        .decorative-border-bottom::before,
        .decorative-border-bottom::after {
            content: '◆';
            position: absolute;
            color: var(--primary-color);
            font-size: 0.8rem;
            top: -6px;
        }

        .decorative-border-top::before,
        .decorative-border-bottom::before {
            left: -10px;
        }

        .decorative-border-top::after,
        .decorative-border-bottom::after {
            right: -10px;
        }

        .poem-category-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 20px;
            font-size: 0.9rem;
            font-family: var(--font-secondary);
            margin: var(--spacing-sm) 0;
            box-shadow: 0 3px 15px rgba(44, 95, 125, 0.3);
            text-align: center;
        }

        .poem-verses-container {
            margin: var(--spacing-xl) 0;
            position: relative;
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl) var(--spacing-lg);
            box-shadow: var(--shadow-md);
            border-right: 3px solid var(--primary-color);
            border-left: 3px solid var(--primary-color);
        }

        .verse-line {
            font-size: 2rem;
            line-height: 3.2;
            color: var(--text-primary);
            text-align: center;
            padding: var(--spacing-sm) var(--spacing-lg);
            font-family: var(--font-decorative);
            transition: color var(--transition-fast);
            font-weight: 500;
        }

        .verse-line:hover {
            color: var(--primary-color);
        }

        .verse-number {
            display: none;
        }

        .poem-navigation {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--border-color);
        }

        .nav-poem-btn {
            flex: 1;
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: var(--font-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            transition: all var(--transition-fast);
        }

        .nav-poem-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
        }

        .nav-poem-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        @media print {
            .navbar, .theme-toggle, .footer, .poem-header, .poem-navigation, .action-btn {
                display: none !important;
            }

            .poem-content-wrapper {
                box-shadow: none;
                padding: 0;
            }

            .poem-content-wrapper::before,
            .poem-content-wrapper::after {
                display: none;
            }

            .poem-verses-container {
                border: none;
                box-shadow: none;
                padding: var(--spacing-md) 0;
            }

            .verse-line {
                page-break-inside: avoid;
                font-size: 1.4rem;
                line-height: 2.8;
                padding: var(--spacing-xs) 0;
            }
        }

        @media (max-width: 768px) {
            .poem-header {
                flex-direction: column;
                gap: var(--spacing-md);
            }

            .poem-main-title {
                font-size: 2rem;
            }

            .verse-line {
                font-size: 1.5rem;
                line-height: 2.8;
                padding: var(--spacing-xs) var(--spacing-md);
            }

            .decorative-ornament {
                font-size: 1.2rem;
                letter-spacing: 0.3rem;
            }

            .poem-navigation {
                flex-direction: column;
            }
        }
    </style>

    <script src="script.js"></script>
    <script>
        // Use poems from script.js, don't redeclare
        let currentPoemIndex = -1;
        let currentView = 'list'; // 'list' or 'grid'

        document.addEventListener('DOMContentLoaded', async function() {
            await loadPoemsForViewer();
            initializeViewer();
        });

        let viewerPoems = [];
        
        async function loadPoemsForViewer() {
            try {
                const response = await fetch('poems.txt');
                const text = await response.text();
                viewerPoems = parsePoemsViewer(text);
                
                // Check if there's a poem parameter in URL
                const urlParams = new URLSearchParams(window.location.search);
                const poemIndex = urlParams.get('poem');
                
                if (poemIndex !== null && viewerPoems[poemIndex]) {
                    showPoemDetail(parseInt(poemIndex));
                } else {
                    showPoemsList();
                }
            } catch (error) {
                console.error('Error loading poems:', error);
                showToast('خطأ في تحميل القصائد');
            }
        }

        function parsePoemsViewer(text) {
            // Split poems by === separator
            const poemBlocks = text.split('===').filter(block => block.trim());
            const poemsArray = [];
            
            for (let block of poemBlocks) {
                const lines = block.trim().split('\n').filter(line => line.trim());
                
                if (lines.length === 0) continue;
                
                // First line is the title
                const title = lines[0].trim();
                let category = 'غير مصنف';
                let startIndex = 1;
                
                // Check if second line is a category (starts with @)
                if (lines.length > 1 && lines[1].trim().startsWith('@')) {
                    category = lines[1].trim().substring(1);
                    startIndex = 2;
                }
                
                // Remaining lines are verses (combine pairs of lines into verses)
                const verses = [];
                let currentVerse = [];
                
                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        currentVerse.push(line);
                        
                        // Every 2 lines form one verse (shatr1 + shatr2)
                        if (currentVerse.length === 2) {
                            verses.push(currentVerse.join('\n'));
                            currentVerse = [];
                        }
                    }
                }
                
                // If there's an odd line left, add it as a single-line verse
                if (currentVerse.length > 0) {
                    verses.push(currentVerse.join('\n'));
                }
                
                poemsArray.push({
                    title: title,
                    verses: verses,
                    category: category
                });
            }
            
            return poemsArray;
        }

        function initializeViewer() {
            // View controls
            document.getElementById('gridViewBtn')?.addEventListener('click', () => {
                currentView = 'grid';
                document.querySelector('.poems-container').classList.remove('list-view');
                document.querySelector('.poems-container').classList.add('grid-view');
                document.getElementById('gridViewBtn').classList.add('active');
                document.getElementById('listViewBtn').classList.remove('active');
            });

            document.getElementById('listViewBtn')?.addEventListener('click', () => {
                currentView = 'list';
                document.querySelector('.poems-container').classList.remove('grid-view');
                document.querySelector('.poems-container').classList.add('list-view');
                document.getElementById('listViewBtn').classList.add('active');
                document.getElementById('gridViewBtn').classList.remove('active');
            });

            // Back button
            document.getElementById('backBtn')?.addEventListener('click', showPoemsList);

            // Poem actions
            document.getElementById('focusModeBtn')?.addEventListener('click', () => {
                window.location.href = `focus.html?poem=${currentPoemIndex}`;
            });

            // Navigation
            document.getElementById('prevPoemBtn')?.addEventListener('click', showPreviousPoem);
            document.getElementById('nextPoemBtn')?.addEventListener('click', showNextPoem);
        }

        function showPoemsList() {
            document.getElementById('poemsListView').style.display = 'block';
            document.getElementById('poemDetailView').style.display = 'none';
            
            const container = document.getElementById('poemsContainer');
            container.className = 'poems-container list-view';
            
            if (viewerPoems.length === 0) {
                container.innerHTML = '<p class="empty-state">لا توجد قصائد متاحة</p>';
                return;
            }

            container.innerHTML = viewerPoems.map((poem, index) => {
                const preview = poem.verses.slice(0, 2).join('<br>');
                return `
                    <div class="poem-item" onclick="showPoemDetail(${index})">
                        <h3 class="poem-item-title">
                            <i class="fas fa-feather-alt"></i>
                            ${poem.title}
                        </h3>
                        <p class="poem-item-preview">${preview}</p>
                        <div class="poem-item-meta">
                            <span class="poem-category">${poem.category}</span>
                            <span><i class="fas fa-align-left"></i> ${poem.verses.length} بيت</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Update URL
            window.history.pushState({}, '', 'viewer.html');
        }

        function showPoemDetail(index) {
            if (index < 0 || index >= viewerPoems.length) return;

            currentPoemIndex = index;
            const poem = viewerPoems[index];

            document.getElementById('poemsListView').style.display = 'none';
            document.getElementById('poemDetailView').style.display = 'block';

            document.getElementById('poemTitle').textContent = poem.title;
            
            // Display category badge if available
            const categoryBadge = document.getElementById('poemCategory');
            if (poem.category && poem.category !== 'غير مصنف') {
                categoryBadge.textContent = poem.category;
                categoryBadge.style.display = 'inline-block';
            } else {
                categoryBadge.style.display = 'none';
            }
            
            const versesContainer = document.getElementById('poemVerses');
            versesContainer.innerHTML = poem.verses.map((verse) => 
                `<p class="verse-line">${verse.replace(/\n/g, '<br>')}</p>`
            ).join('');

            // Update navigation buttons
            document.getElementById('prevPoemBtn').disabled = index === 0;
            document.getElementById('nextPoemBtn').disabled = index === viewerPoems.length - 1;

            // Update URL
            window.history.pushState({}, '', `viewer.html?poem=${index}`);

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function showPreviousPoem() {
            if (currentPoemIndex > 0) {
                showPoemDetail(currentPoemIndex - 1);
            }
        }

        function showNextPoem() {
            if (currentPoemIndex < viewerPoems.length - 1) {
                showPoemDetail(currentPoemIndex + 1);
            }
        }


    </script>
    
</body>
</html>