// تفعيل الوضع الليلي من التخزين المحلي وتنفيذ التبديل عبر الزر
document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("toggle-dark-mode");
  toggleBtn.addEventListener("click", () => {
    document.documentElement.classList.toggle("dark");
    const isDark = document.documentElement.classList.contains("dark");
    localStorage.setItem("darkMode", isDark ? "on" : "off");
  });
});

// مصفوفات لتخزين القصائد والأبيات
let poemList = [];
let allLines = [];

// تحميل القصائد وتشغيل العرض
async function loadPoems() {
  try {
    const txt = await fetch("poems.txt?update=" + Date.now()).then(res => res.text());
    const poems = txt.split("===\n").map(p => p.trim()).filter(p => p);
    poemList = poems.map((p, i) => {
      const lines = p.split("\n");
      return {
        id: i,
        title: lines[0] || "",
        category: lines[1] ? lines[1].replace("@", "").trim() : "",
        lines: lines.slice(2)
      };
    });
    displayPoemList(poemList);
    extractBayt(poems);
  } catch (err) {
    console.error("خطأ في تحميل القصائد:", err);
  }
}

// عرض قائمة القصائد
function displayPoemList(arr) {
  const list = document.getElementById("list");
  list.innerHTML = "";
  arr.forEach(p => {
    const a = document.createElement("a");
    a.className = "poem-card fade";
    a.href = `viewer.html?id=${p.id}`;
    a.textContent = p.title || "بدون عنوان";
    list.appendChild(a);
  });
}

// البحث داخل العنوان، التصنيف، والنص الكامل
function runSearch() {
  const term = document.getElementById("search").value.trim().toLowerCase();
  if (!term) {
    displayPoemList(poemList);
    return;
  }
  const filtered = poemList.filter(p => {
    const titleMatch = p.title.toLowerCase().includes(term);
    const categoryMatch = p.category.toLowerCase().includes(term);
    const linesMatch = p.lines.some(line => line.toLowerCase().includes(term));
    return titleMatch || categoryMatch || linesMatch;
  });
  displayPoemList(filtered);
}

// اختيار قصيدة عشوائية
function randomPoem() {
  if (poemList.length === 0) return;
  const id = Math.floor(Math.random() * poemList.length);
  window.location.href = `viewer.html?id=${id}`;
}

// استخراج بيت اليوم
function extractBayt(poems) {
  allLines = [];
  poems.forEach(poem => {
    const lines = poem.split("\n").slice(2).filter(l => l.trim() !== "");
    allLines.push(...lines);
  });
  if (allLines.length === 0) return;
  const today = new Date().getDate();
  const index = today % allLines.length;
  const l1 = allLines[index] || "";
  const l2 = allLines[(index + 1) % allLines.length] || "";
  document.getElementById("todayContent").innerHTML = `${l1}<br>${l2}`;
}

// بدء التنفيذ
loadPoems();
